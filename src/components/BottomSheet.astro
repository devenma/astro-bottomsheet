---
import "../styles/globals.css";

/**
 * BottomSheet Component for Astro
 * A draggable bottom panel component for displaying information
 *
 * @example
 * import BottomSheet from '@/components/BottomSheetAstro/BottomSheet.astro';
 * <BottomSheet sections={3} />
 */

interface Props {
  class?: string;
  sections?: number;
  baseColor?: string;
  textColor?: string;
  borderColor?: string;
  options?: {
    closeOnOverlayClick?: boolean;
  };
}

const {
  class: className = "",
  sections = 3,
  baseColor = "#ffffff",
  textColor = "#0f172a",
  borderColor = "#e2e8f0",
  options = { closeOnOverlayClick: false },
} = Astro.props;
---

<!-- BottomSheet -->
<div
  id="bottomsheet-container"
  class="bottomsheet-container bs:fixed bs:inset-0 bs:flex bs:items-end bs:md:items-center bs:justify-center bs:z-50"
  data-options={JSON.stringify(options)}
  style={`
      --bottomsheet-base-color: ${baseColor};
      --bottomsheet-text-color: ${textColor};
      --bottomsheet-border-color: ${borderColor};
    `}
>
  <div
    id="bottomsheet"
    class:list={[
      "bs:border bs:border-transparent bs:cursor-auto bs:duration-600 bs:ease-in-out bs:flex bs:flex-col bs:h-0 bs:self-end bs:md:border-t-transparent bs:md:flex-row bs:md:h-full bs:md:ml-auto bs:md:mt-0 bs:md:rounded-t-none bs:md:w-0 bs:mt-auto bs:pointer-events-auto bs:relative bs:rounded-t-4xl bs:transition-all bs:w-full bs:will-change-auto bs:z-50 bs:md:max-w-125",
      className,
    ]}
  >
    <!-- Drag Handle -->
    <div
      id="bottomsheet-drag-handle"
      class="bs:flex bs:items-center bs:py-2 bs:md:py-0 bs:md:px-3 bs:justify-center bs:cursor-grab"
    >
      <div
        class="bottomsheet-line bs:w-10 bs:md:w-auto bs:md:h-16 bs:border-b-4 bs:md:border-b-0 bs:md:border-l-4 bs:rounded-full"
        style={`border-color: color-mix(in srgb, ${borderColor} 80%, transparent);`}
      >
      </div>
    </div>

    <!-- Content Wrapper -->
    <div id="bottomsheet-content-wrapper" class="bs:flex bs:flex-col bs:w-full">
      <!-- Header -->
      <header
        id="bottomsheet-header"
        class="bs:flex bs:gap-4 bs:py-2 bs:px-1 bs:items-center bs:border-b bs:shrink-0"
        style={`border-color: ${borderColor};`}
      >
        <h2
          id="bottomsheet-title"
          class="bs:m-0 bs:italic bs:font-light bs:max-md:text-xl bs:md:text-3xl bs:md:font-medium bs:text-nowrap bs:text-ellipsis bs:overflow-hidden"
          style={`color: ${textColor};`}
        >
        </h2>
        <div
          id="bottomsheet-share-btn"
          class="bottomsheet-header-btn bs:ml-auto"
        >
          <span class="bs:hidden"></span>
        </div>
        <button
          id="bottomsheet-close-btn"
          class="bottomsheet-close-btn bottomsheet-header-btn bs:text-base bs:transition bs:rounded-full bs:p-2 bs:cursor-pointer bs:size-8 bs:flex bs:items-center bs:justify-center"
          style={`
            color: color-mix(in srgb, ${textColor} 70%, transparent);
            fill: color-mix(in srgb, ${textColor} 70%, transparent);
            background-color: color-mix(in srgb, ${textColor} 10%, transparent);
          `}
          title="Close"
        >
          <svg
            fill="currentColor"
            viewBox="0 0 384 512"
            width="1em"
            height="1em"
          >
            <path
              d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L236.7 256 342.6 150.6z"
            ></path>
          </svg>
        </button>
      </header>

      <!-- Content -->
      <div
        id="bottomsheet-content"
        class="bs:p-4 bs:flex bs:flex-col bs:gap-2 bs:overflow-y-auto bs:overflow-x-hidden bs:flex-1"
      >
        <!-- Error Message (always present, hidden by default) -->
        <section
          id="bottomsheet-error"
          class="bottomsheet-section bs:flex-col bs:items-start bs:gap-4 bs:md:min-w-48 bs:lg:min-w-64 bs:xl:min-w-81 bs:hidden"
          style={`color: ${textColor};`}
        >
          <div
            class="bottomsheet-error bs:flex-col bs:gap-4 bs:w-full bs:flex bs:items-center bs:text-xl bs:text-center"
            style={`color: color-mix(in srgb, ${textColor} 60%, transparent);`}
          >
            <svg
              class="bs:text-4xl bs:rounded-full"
              style={`color: color-mix(in srgb, ${textColor} 40%, transparent);`}
              fill="currentColor"
              viewBox="0 0 512 512"
              width="1em"
              height="1em"
            >
              <path
                d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"
              ></path>
            </svg>
            <span>Algo salió mal.<br />Vuelve a intentar más tarde.</span>
          </div>
        </section>

        <!-- Dynamic Sections -->
        {
          Array.from({ length: sections }, (_, i) => (
            <section
              id={`bottomsheet-section-${i}`}
              class="bottomsheet-section bs:flex bs:flex-col bs:items-start bs:gap-4 bs:md:min-w-48 bs:lg:min-w-64 bs:xl:min-w-81"
              style={`color: ${textColor};`}
            />
          ))
        }
      </div>
    </div>
  </div>
</div>

<style>
  /* Estilos específicos que no se pueden expresar con Tailwind */

  #bottomsheet-container {
    visibility: hidden;
    pointer-events: none;
    color: var(--bottomsheet-text-color);
  }

  #bottomsheet-container:has(#bottomsheet.bottomsheet-open) {
    visibility: visible;
    pointer-events: auto;
  }

  #bottomsheet-container:has(#bottomsheet.bottomsheet-minimized) {
    pointer-events: none;
  }

  #bottomsheet {
    background-color: var(--bottomsheet-base-color);
  }

  @media (width < 768px) {
    #bottomsheet {
      border-top-color: var(--bottomsheet-border-color);
    }
  }

  @media (width >= 768px) {
    #bottomsheet {
      border-left-color: var(--bottomsheet-border-color);
    }
  }

  /* BottomSheet states */
  #bottomsheet.bottomsheet-dragging {
    transition: none;
  }

  #bottomsheet.bottomsheet-open {
    height: 50%;
    padding: 1rem;
    padding-top: 0;
  }

  @media (min-width: 768px) {
    #bottomsheet.bottomsheet-open {
      padding-top: 1rem;
      padding-left: 0;
      height: 100%;
      width: 33.333333%;
    }
  }

  #bottomsheet.bottomsheet-open.bottomsheet-minimized {
    height: 0;
  }

  @media (min-width: 768px) {
    #bottomsheet.bottomsheet-open.bottomsheet-minimized {
      height: 100%;
      width: 2rem;
      backdrop-filter: blur(4px);
    }

    #bottomsheet.bottomsheet-open.bottomsheet-minimized
      #bottomsheet-content-wrapper {
      opacity: 0;
      transition: all 0.3s 0.2s;
    }
  }

  #bottomsheet.bottomsheet-open.bottomsheet-updating #bottomsheet-header,
  #bottomsheet.bottomsheet-open.bottomsheet-updating
    section.bottomsheet-section {
    transition-delay: 0s;
    transition-duration: 0.3s;
    transition-property: all;
    border-radius: 0.5rem;
    overflow: hidden;
    background-color: color-mix(
      in srgb,
      var(--bottomsheet-border-color) 50%,
      transparent
    );
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    * {
      opacity: 0 !important;
    }
  }

  #bottomsheet.bottomsheet-open.bottomsheet-updating #bottomsheet-header *,
  #bottomsheet.bottomsheet-open.bottomsheet-updating
    section.bottomsheet-section
    * {
    opacity: 0 !important;
  }

  #bottomsheet.bottomsheet-open.bottomsheet-dragging {
    transition: none;
    user-select: none;
  }

  /* Hover state for close button */
  #bottomsheet-close-btn:hover {
    color: var(--bottomsheet-text-color) !important;
    fill: var(--bottomsheet-text-color) !important;
    background-color: color-mix(
      in srgb,
      var(--bottomsheet-text-color) 20%,
      transparent
    ) !important;
  }

  /* Content error state */
  #bottomsheet-content.bottomsheet-error > :not(#bottomsheet-error) {
    display: none;
  }

  #bottomsheet-error.bottomsheet-active {
    display: flex;
    align-items: center;
  }

  /* Store info hover effects */
  .bottomsheet-info-text:hover svg {
    fill: var(--bottomsheet-text-color);
  }
</style>

<script>
  import BottomSheet from "../core/BottomSheet.js";
  import { setBottomSheet } from "../core/bottomSheetInstance.js";

  // Initialize BottomSheet when the component is loaded
  const bottomsheet = document.getElementById("bottomsheet");
  if (bottomsheet) {
    const options = JSON.parse(
      bottomsheet.parentElement?.dataset.options || "{}"
    );
    const bottomSheet = new BottomSheet(bottomsheet, options);

    // Register the instance for global access
    setBottomSheet(bottomSheet);
  }
</script>
